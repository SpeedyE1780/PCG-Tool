= PCG Engine Presentation

== High Level Concept

=== Elevator Pitch

The **P**rocedural **C**ontent **G**eneration (PCG) Engine is a {cpp} library used to generate content procedurally.

=== Aim of Project

The aim of the PCG Engine is to be usable with no knowledge of how procedural algorithm work. You just pass in a callback and let the engine do all the work and notify you when something is generated.

=== What Was Proposed

- **Level Generation:**

[x] **Simple Generation:** Spawn nodes following a unit vector.

[x] **Multi Dimension Generation:** Spawn nodes on the chosen axes.

[x] **Wave Function Collapse Generation:** Spawn nodes on the chosen axes where each node has a set of adjacent nodes.

[NOTE]
The Wave Function Collapse algorithm was created by https://github.com/mxgmn/WaveFunctionCollapse/blob/master/README.md[Maxim Gumin].
It is very similar to an AI concept: Constraint Satisfaction Problem (CSP) explained in Artificial Intelligence a Modern Approach Third Edition p202.
In my implementation the graph is initially empty and each node is added iteratively when a node is added it adds its adjacent node to the graph and create a constraint between them that needs to be satisfied.

[x] **Grid 2D / 3D Wave Function Collapse Generation:** Spawn nodes in the grid where each node has a set of adjacent nodes.

[ ] **Graph Rewriting:** Allow passing in rules and patterns to the generation algorithm and subgraphs that matches rules to given patterns.

[x] **Maze Generation:** Spawn nodes with adjacent nodes to form a maze following a chosen algorithm.

[NOTE]
The maze algorithm are taken from Jamis Buck presentation: https://www.jamisbuck.org/presentations/rubyconf2011/index.html["Algorithm" is not a four letter word.] and his Better Recursive Division Algorithm https://weblog.jamisbuck.org/2015/1/15/better-recursive-division-algorithm.html[blog]

- **Combination Generation:**

[NOTE]
A set of n elements has 2^n^ possible subsets as proven by the Binomial Theorem (Discrete Mathematics and Its Applications, Seventh Edition
by Rosen, Kenneth p 417).
A set can be represented using a n bit number(Discrete Mathematics and Its Applications, Seventh Edition
by Rosen, Kenneth p 134). If the x^th^ is 1 then the x^th^ element in the set is included in the set.
To generate a combination I generate a random number between 0 and 2^n^ and check the which bit is active. 

[x] **Combination:** Generate a combination from a set of elements.

[x] **Combination with Minimum Elements:** Generate a combination from a set with at least x elements.

[x] **Combination with Active Elements:** Generate a combination from a set with chosen elements active.

- **Sequence Generation:**

[x] **Linear Sequence:** Given a start node choose a random next node and repeat the process until the current node has no next node.

[x] **Cyclic Sequence:** Given a start node choose a random next node and repeat the process until the chosen length is reached.

- **Languages:**

[x] **C#:** A C# library is available that wraps the {cpp} library and allows calling the native functions.

[x] **Python:** A Python library is available that wraps the {cpp} library and allows calling the native functions.

- **Engines:**

[x] **Unity:** A Unity package was developed that relies on the C# Wrapper.
The package adds editor windows that allows generating content during edit mode.
Content can also be generated during play mode using only the C# Wrapper if the editor windows are not needed.

[x] **Unreal:** An Unreal plugin was developed that adds the {cpp} library as a third party and allows generating content during runtime.
A second plugin was developed that adds editor window and allows generating content during edit mode.

- **Web Services:**

[x] **PCG Web API:** The PCG Web API is an ASP.NET Core REST API.
It takes the parameters in the request body and uses the C# Wrapper to generate content and returns the result as JSON in the response.

[x] **PCG Web APP:** The PCG Web APP is a web application that allows preview the engine's functionality on the web.
It shows the result of combinations and sequences as text output.
It displays the result of level generation using the PlayCanvas engine and allows moving around in the scene to look at the result.
The generated JSON can be copied from the text area where it is displayed.

== Development Approach and Answers

=== https://github.com/SpeedyE1780/PCG-Tool/issues?q=label%3Aweek-1[Week 1]

- **Developments:**

    * During the first week my main objective was to create an MVP to test the communication between the engine and different engines (ex: Unity, Unreal, GAM703 Engine).

- **Questions:**

    * https://discussions.unity.com/t/is-c-cli-forbidden-in-unity/748312/10[Is {cpp}/CLI compatible with unity]? No following this https://discussions.unity.com/t/is-c-cli-forbidden-in-unity/748312/10[comment] the transition from a Non **J**ust **I**n **T**ime compiled language to a JIT language causes a crash.

    * https://stackoverflow.com/questions/1533916/how-to-set-up-a-c-function-so-that-it-can-be-used-by-p-invoke/1533956#1533956[Disable name mangling to use function with P/Invoke]? export function using `extern "C"`.

    * https://stackoverflow.com/questions/4804494/p-invoking-function-via-a-mangled-name[Invoke function who's name is mangled]? Modify the EntryPoint of the DllImport attribute.

    * Use {cpp} enums in C#? https://stackoverflow.com/a/57546086[Re-declare enums in C#] or https://stackoverflow.com/a/18786[Use the PInvoke Interop Assistant tool to generate enums in C#]

=== https://github.com/SpeedyE1780/PCG-Tool/issues?q=label%3Aweek-2[Week 2]

- **Developments:**

    * Refactors in the engine and Unity.

    * Implement the maze generation algorithms.

    * Create C DLL and CPP DLL that are used with Unity and Unreal.

- **Questions:**

    * Adding Third Party Libraries in Unreal? https://unrealcommunity.wiki/adding-custom-third-party-library-to-plugin-from-scratch-867b28[Unreal wiki third party plugin.]

    * https://www.gamedev.net/forums/topic/690804-problem-with-enum-and-binary-or-operator/[Should enums be used as flags]? Personally I prefer using enums as flags since it's a common practice that's used in multiple projects.
    It can give you type safety you can't compare two different enums but you can compare two different std::bitset that don't represent the same thing.

    * https://discussions.unity.com/t/how-to-step-into-a-native-c-dll-in-visual-studio/631995[How to debug native DLL in Unity project]? Open the native project in visual studio and attach the debugger to the unity project once the native code is called the breakpoint will be hit.

    * https://forums.unrealengine.com/t/c-bitmask-enums-appear-to-be-offset-by-1/370610[Declare enum as flag in Unreal]?
    1. Add the meta = (Bitflags) to the UENUM macro
    2. Add meta=(Bitmask, BitmaskEnum = "(EnumType)") to the UPROPERTY macro

    * How to add details panel to Unreal Widget? https://codekittah.medium.com/custom-details-panels-in-unreal-engine-fpropertyeditormodule-6fe41ba7c339[Add details panel to Unreal widget]

    * https://forums.unrealengine.com/t/getting-world-in-a-editor-plugin/324825[Get world in an editor window]? `GEditor->GetEditorWorldContext().World()`

=== https://github.com/SpeedyE1780/PCG-Tool/issues?q=label%3Aweek-3[Week 3]

- **Developments:**

    * Add combination generation.

    * Refactors in the {cpp} engine.

    * Add general documentation for the engine using asciidoc for the proposal submission.

- **Questions:**

    * https://stackoverflow.com/questions/7230621/how-can-i-iterate-over-a-packed-variadic-template-argument-list[Iterate over variadic template]? https://stackoverflow.com/a/50892567[Stack Overflow answer]`for(const auto p : {things...})`

    * https://stackoverflow.com/questions/17032310/how-to-make-a-variadic-is-same[Check variadic template types]? https://stackoverflow.com/a/39550575[Stack Overflow answer] `concept are_same = std::conjunction_v<std::is_same<T, Ts>...>;`

    * https://stackoverflow.com/questions/30101191/can-i-call-a-c-function-from-javascript[Call {cpp} function from JS]? https://stackoverflow.com/a/32237343[Stack Overflow answer] Wrap {cpp} to web service.

    * https://forums.unrealengine.com/t/what-versions-of-c-are-compatible-with-ue/657406/2[Unreal {cpp} standard]? {cpp} 17

    * https://forums.unrealengine.com/t/how-to-get-selected-objects-in-editor/320900/3[Get selected actors in Unreal]? `GEditor->GetSelectedActors()`

    * https://stackoverflow.com/questions/252417/how-can-i-use-a-dll-file-from-python[Use {cpp} DLL with Python]? Using ctypes native DLL functions can be called.

=== https://github.com/SpeedyE1780/PCG-Tool/issues?q=label%3Aweek-4[Week 4]

- **Developments:**

    * Implement the remaining algorithms from Jamis Buck presentation: https://www.jamisbuck.org/presentations/rubyconf2011/index.html["Algorithm" is not a four letter word.]

- **Questions:**

    * https://stackoverflow.com/questions/2999506/non-member-conversion-functions-casting-different-types-e-g-directx-vector-to[{cpp} conversion function]? `operator int() const`

    * https://stackoverflow.com/questions/644629/base-enum-class-inheritance[{cpp} enum inheritance]? No.

=== https://github.com/SpeedyE1780/PCG-Tool/issues?q=label%3Aweek-5[Week 5]

- **Developments:**

    * Implement new maze changes in Unity and Unreal
    
    * Add a general documentation page for maze target.

- **Questions:**

    * https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-creation[.lib file importance]? The .lib file resolve external references to exported DLL functions.

=== https://github.com/SpeedyE1780/PCG-Tool/issues?q=label%3Aweek-6[Week 6]

- **Developments:**

    * Add golden value tests to the maze generation target to preserve the output after implementing new issues.

    * Add the grid wave function collapse to the level generation target and implement it with Unity.

- **Questions:**

    * https://www.sandordargo.com/blog/2019/04/24/parameterized-testing-with-gtest[How to create {cpp} parametrized tests]?

        1. Inherit from testing::TestWithParam<T>

        2. Use TEST_P(ClassName, TestName)

        3. INSTANTIATE_TEST_CASE_P(TestPrefix, ClassName, Values) 

    * https://stackoverflow.com/questions/46023379/generate-suffix-for-test-according-to-parameter-in-gtest-frame-work[Generate suffix for {cpp} parametrized test]? Pass in functor as 4th argument to generate a string from the test's argument.

=== https://github.com/SpeedyE1780/PCG-Tool/issues?q=label%3Aweek-7[Week 7]

- **Developments:**

    * Add golden value tests to level generation target to preserve the output after implementing new issues.

    * Update the level generation documentation.

    * Add sequence generation to {cpp} engine.

- **Questions:**

    * https://discussions.unity.com/t/is-there-any-reason-to-use-unsafe-code-in-unity-in-2023/920022[Using unsafe in Unity]?

    * https://stackoverflow.com/questions/2415017/convert-from-double-array-to-pointer[Convert C# Array in to Pointer]? `fixed int* ptr = array`

=== https://github.com/SpeedyE1780/PCG-Tool/issues?q=label%3Aweek-8[Week 8]

- **Developments:**

    * Add sequence generation to Unity.

    * Document sequence generation.

    * Add a python wrapper for the combination target.

    * Refactor sequence generation to facilitate the C# and Python implementation.

- **Questions:**

    * https://stackoverflow.com/questions/3355014/structlayout-only-for-struct[Can StructLayout be used with classes]? Yes.

    * https://stackoverflow.com/questions/55093619/marshaling-c-sharp-struct-with-array-of-structs-and-size-param-index[Marshal class containing a class Array]? Use byte arrays.

    * https://stackoverflow.com/questions/20597006/how-to-pass-a-pointer-from-c-sharp-to-native-function-in-dll[Pass an IntPtr to {cpp}]?

    * https://stackoverflow.com/questions/8162994/why-arent-static-data-members-allowed-in-local-classes[Can local classes have static variables in {cpp}]? No because local classes have no linkage.

    * https://stackoverflow.com/questions/5714616/usage-of-local-class-in-c-function[Local classes usage in {cpp}]?

    * https://stackoverflow.com/questions/5081875/ctypes-beginner[How to use ctypes in Python]?

    * https://stackoverflow.com/questions/40843039/how-can-i-write-a-simple-callback-function[Create lambda in Python]? `lambda x, y: add(x, y)`

    * https://stackoverflow.com/questions/20309456/how-do-i-call-a-function-from-another-py-file[How to import functions from files in Python]?

    * https://stackoverflow.com/questions/6434482/python-function-overloading[Why overloading doesn't work in Python]? Overloaded method is chosen at compile time the alternative in Python is Multiple Dispatch.

    * https://stackoverflow.com/questions/4145775/how-do-i-convert-a-python-list-into-a-c-array-by-using-ctypes[How to pass an array using ctypes]?

    * https://stackoverflow.com/questions/1615813/how-to-use-c-classes-with-ctypes[Use {cpp} class in Python]?

    * https://stackoverflow.com/questions/27663205/passing-a-python-object-to-c-module[Define a {cpp} class in Python]? The class needs to inherit from `ctypes.Structure` and set the `++_fields_++` variable

    * https://stackoverflow.com/questions/72036758/unhashable-type-in-python[Ctypes Unhashable type error]? `ctypes.pointer` was used with a class type instead of class instance.

    * https://stackoverflow.com/questions/33005127/python-ctypes-callback-function-gives-typeerror-invalid-result-type-for-callba[Ctypes type error invalid result type for function]? This is a bug in ctypes only primitive types can be returned from a function.

    * https://stackoverflow.com/questions/1942298/wrapping-a-c-library-in-python-c-cython-or-ctypes[Ctypes vs Cython]? Cython sounds better if the library is being written from scratch.
    Since my library is already written and I just need to call the exposed functions using ctypes felt like a better choice.

=== https://github.com/SpeedyE1780/PCG-Tool/issues?q=label%3Aweek-9[Week 9]

- **Developments:**

    * Fix the project structure.

    * Update PCG Engine documentation.

    * Change C# wrapper to a class library and use the generated DLL with Unity.
    
- **Questions:**

    * https://stackoverflow.com/questions/49581761/dll-export-symbol-of-function-from-static-linked-library[Export symbols from static libraries]? Add the export macro the desired functions.

    * https://stackoverflow.com/questions/2028264/visual-studio-with-doxygen-for-documentation-or-should-we-use-something-else[Setup doxygen documentation with C#]? Just use the XML comments since doxygen supports parsing XML.

    * https://stackoverflow.com/questions/58950859/default-implementation-in-interface-is-not-seen-by-the-compiler[Use default interface implementation in C# class]?

    * https://stackoverflow.com/questions/4074585/attempted-to-read-or-write-protected-memory-this-is-often-an-indication-that-ot[How to enable native debugging in C# project]? Enable the option in the project settings.

    * https://stackoverflow.com/questions/9577487/pointer-is-pointing-to-0x1-is-checking-for-null-valid[Pointer address is 0x1]? This means a null pointer is being dereferenced.

    * https://discussions.unity.com/t/unable-to-load-attribute-info-on-field-are-you-missing-a-reference/887696/4[Unity typecache error unable to load attribute error]? This means that either the DLL is compiled with a .net version that isn't supported. Or the type used with in the editor window hasn't been loaded from the DLL yet.
    
=== https://github.com/SpeedyE1780/PCG-Tool/issues?q=label%3Aweek-10[Week 10]

- **Developments:**

    * Wrap the {cpp} library in python and added documentation.

    * Add a combination demo and maze demo using pygame to the python wrapper.

    * Add {cpp} combination generation tests and fixed an issue where the test order would change the results because the RNG seed wasn't reset between tests.

- **Questions:**

    * https://stackoverflow.com/questions/49672264/cmake-add-d-suffix-for-debug-build-of-static-library[Add debug suffix to DLL/Lib with Cmake]? `set(CMAKE_DEBUG_POSTFIX d)` for all targets or `set_target_properties(<target-name> PROPERTIES DEBUG_POSTFIX "d")` for chosen targets.

    * https://docs.python.org/3/howto/enum.html[How to declare enums in Python]?

    * https://stackoverflow.com/questions/394809/does-python-have-a-ternary-conditional-operator[Ternary operator in Python]? `x if condition else y`.

    * https://stackoverflow.com/questions/42127593/should-python-class-filenames-also-be-camelcased[Python naming conventions]?

    * https://www.digitalocean.com/community/tutorials/python-str-repr-functions[Override the 'toString()' method in Python]? Implement the `++__str__++` function.

    * https://stackoverflow.com/questions/56129479/how-to-debug-a-dll-in-visual-studio-that-i-call-from-python-using-ctypes[Enable native debugging in Python project]?

    * https://stackoverflow.com/questions/17301091/python-lifetime-of-module-global-variables[Lifetime of module global variables]? The logging and rng callbacks are global variables who are either deleted manually or when the script exits.

    * https://www.w3schools.com/python/python_variables_global.asp[Assign global variable in function body]? `global x x = 1`

    * https://www.geeksforgeeks.org/python-docstrings/[Python documentation conventions]?

    * https://stackoverflow.com/questions/6060813/how-to-document-fields-and-properties-in-python[Document a variable in Python]?

    * https://stackoverflow.com/questions/1995615/how-can-i-format-a-decimal-to-always-show-2-decimal-places[How to format a string in Python]?

=== https://github.com/SpeedyE1780/PCG-Tool/issues?q=label%3Aweek-11[Week 11]

- **Developments:**

    * Add cyclic sequence generation to engine and wrappers.

    * Maintain prefabs links when spawning from editor window.

    * Add Unity maze game demo.

- **Questions:**

    * https://stackoverflow.com/questions/29932342/is-there-a-way-to-ignore-calculating-language-statistics-for-a-directory-on-gith[Ignore folder from language statistics]? Add folder in the .gitattributes as `linguist-vendored`

    * https://stackoverflow.com/questions/2152077/is-it-possible-to-get-cmake-to-build-both-a-static-and-shared-library-at-the-sam[Make target both static and shared]? Create two target with different names with the same source files.

    * https://stackoverflow.com/questions/32994598/how-to-include-documentation-in-dll-to-show-method-summary-in-unity3d#:~:text=Under%20the%20"Build"%20side%20tab,put%20the%20documentation%20into%20Intellisense[Import C# DLL documentation in Unity]? Add the .xml file in the same folder as the DLL.

    * https://stackoverflow.com/questions/1096568/how-can-i-use-interface-as-a-c-sharp-generic-type-constraint[Constrain Template type to be an interface]? This is not possible.

    * https://stackoverflow.com/questions/1339976/how-to-check-if-any-flags-of-a-flag-combination-are-set[Check if flag is active in a C# Enum]? Enums has the `HasFlag` method that is used to check flags.

    * https://forums.unrealengine.com/t/does-ue-4-10-support-uclass-ustruct-in-namespaces/352448/6[Why namespace aren't supported in Unreal]?

=== https://github.com/SpeedyE1780/PCG-Tool/issues?q=label%3Aweek-12[Week 12]

I updated the unreal plugin.

I added unit tests to the C# and Python wrappers to make sure the output matches the golden values used with the {cpp} targets.

I developed the PCG REST API and the PCG web app to preview the results of the web api using playcanvas.

Added some edge cases tests in non cyclic sequences and combination generations.

Replaced the simpleGeneration function to take a vector offset instead of the axis argument.

Replace the return of the cyclic sequence generation from a vector to a callback.

Delete CallbackFunctor class that is basically a clone of std::function.

=== https://github.com/SpeedyE1780/PCG-Tool/issues?q=label%3Aweek-13[Week 13]

Did some small refactoring.

Updated the wrappers, web services and plugins engine implementation.

Added documentation for Unity, Unreal, REST API and Web app.

Add journal entries to repo.

Add readme as a general overview for the repo.

== Value and Future Work


